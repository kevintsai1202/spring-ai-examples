# 5.8 Function Calling (ä¸‹) - é€²éšå·¥å…·éˆèˆ‡å¤šæ­¥é©Ÿä»»å‹™

> **å°æ‡‰ç¯„ä¾‹**: `chapter5-spring-ai-advanced`
> **é›£åº¦**: â­â­â­â­â˜†

---

## ğŸ“š æœ¬ç« æ¦‚è¦

å·¥å…·éˆï¼ˆTool Chainï¼‰æ˜¯ Spring AI çš„é€²éšç‰¹æ€§ï¼Œå…è¨± AI è‡ªå‹•é€²è¡Œå¤šå±¤æ¬¡çš„å·¥å…·èª¿ç”¨ã€‚èˆ‡å–®ä¸€å·¥å…·ç›¸æ¯”ï¼Œå·¥å…·éˆèƒ½è®“ AI åƒäººé¡ä¸€æ¨£æ€è€ƒï¼šã€Œè¦å®Œæˆé€™å€‹ä»»å‹™ï¼Œæˆ‘éœ€è¦å…ˆåš Aï¼Œç„¶å¾Œæ ¹æ“š A çš„çµæœåš Bï¼Œæœ€å¾Œç”¨ C ä¾†æ•´åˆã€ã€‚

**å­¸ç¿’ç›®æ¨™**:
- ç†è§£å·¥å…·éˆçš„è‡ªå‹•èª¿ç”¨æ©Ÿåˆ¶
- æŒæ¡è¤‡é›œå·¥å…·éˆçš„è¨­è¨ˆæ¨¡å¼
- å­¸æœƒå»ºç«‹ä¼æ¥­ç´šå·¥å…·ç”Ÿæ…‹ç³»çµ±
- äº†è§£å·¥å…·éˆçš„æ•ˆèƒ½å„ªåŒ–ç­–ç•¥

---

## ğŸ¯ ç‚ºä»€éº¼éœ€è¦å·¥å…·éˆ?

### å‚³çµ±æ–¹å¼çš„é™åˆ¶

æƒ³åƒä¸€å€‹å ´æ™¯ï¼šç”¨æˆ¶å•ã€Œå»å¹´æœ€ç†±éŠ·çš„ç”¢å“æœ‰å“ªäº›å‹è™Ÿï¼Ÿã€

**âŒ å‚³çµ±å–®ä¸€å·¥å…·åšæ³•**:
```java
@Tool(description = "Get all product information including sales and models")
public ProductFullInfo getProductFullInfo(String year) {
    // åœ¨ä¸€å€‹å·¥å…·è£¡åšæ‰€æœ‰äº‹æƒ…ï¼š
    // 1. æŸ¥è©¢éŠ·å”®è³‡æ–™
    // 2. æ‰¾å‡ºæœ€ç†±éŠ·ç”¢å“
    // 3. æŸ¥è©¢ç”¢å“å‹è™Ÿ
    // 4. æŸ¥è©¢æ¯å€‹å‹è™Ÿçš„è¦æ ¼
    // 5. çµ±è¨ˆåˆ†æ...

    return hugeResult; // è¿”å›ä¸€å¤§åŒ…è³‡æ–™
}
```

**å•é¡Œ**:
- ğŸ“¦ ä¸€æ¬¡è¿”å›å¤§é‡è³‡æ–™ï¼Œæµªè²» tokens
- ğŸ”§ å·¥å…·åŠŸèƒ½éæ–¼è¤‡é›œï¼Œé›£ä»¥ç¶­è­·
- ğŸ¯ ç„¡æ³•æ ¹æ“šä¸­é–“çµæœå‹•æ…‹èª¿æ•´ç­–ç•¥
- ğŸ”„ é‡è¤‡ä½¿ç”¨æ€§å·®

**âœ… å·¥å…·éˆåšæ³•**:
```java
// å·¥å…· 1: éŠ·å”®æ’è¡Œ
@Tool(description = "Get product sales ranking for a specific year")
public SalesRanking getProductSalesRanking(int year) { ... }

// å·¥å…· 2: ç”¢å“å‹è™Ÿ
@Tool(description = "Get product models by product code")
public ProductDetail getProductModels(String product) { ... }

// å·¥å…· 3: å‹è™Ÿè¦æ ¼
@Tool(description = "Get model specifications")
public ProductModel getModelSpecifications(String productCode, String modelCode) { ... }
```

**å„ªå‹¢**:
- âœ… æŒ‰éœ€èª¿ç”¨ï¼Œç¯€çœ tokens
- âœ… å·¥å…·è·è²¬å–®ä¸€ï¼Œæ˜“æ–¼ç¶­è­·
- âœ… AI å¯å‹•æ…‹èª¿æ•´èª¿ç”¨ç­–ç•¥
- âœ… å·¥å…·å¯ç¨ç«‹é‡ç”¨

---

## ğŸ”— å·¥å…·éˆåŸ·è¡Œæµç¨‹

### è‡ªå‹•éˆå¼èª¿ç”¨æ©Ÿåˆ¶

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ¶
    participant AI as Spring AI
    participant T1 as éŠ·å”®å·¥å…·
    participant T2 as ç”¢å“å·¥å…·
    participant T3 as è¦æ ¼å·¥å…·

    U->>AI: ã€Œ2023å¹´æœ€ç†±éŠ·ç”¢å“æœ‰å“ªäº›å‹è™Ÿï¼Ÿã€

    Note over AI: åˆ†æå•é¡Œ:<br/>éœ€è¦éŠ·å”®è³‡æ–™
    AI->>T1: getProductSalesRanking(2023)
    T1-->>AI: æœ€ç†±éŠ·: PD-1385 æ™ºèƒ½æ‰‹éŒ¶

    Note over AI: æ ¹æ“šçµæœåˆ¤æ–·:<br/>éœ€è¦æŸ¥è©¢å‹è™Ÿ
    AI->>T2: getProductModels("PD-1385")
    T2-->>AI: å‹è™Ÿåˆ—è¡¨: 1385-1, 1385-2, 1385-3, 1385-4

    Note over AI: æ±ºå®šæŸ¥è©¢<br/>æ¯å€‹å‹è™Ÿè¦æ ¼
    AI->>T3: getModelSpecifications("PD-1385", "1385-1")
    T3-->>AI: è¦æ ¼: 41mm, GPS, å¿ƒç‡ç›£æ¸¬

    AI->>T3: getModelSpecifications("PD-1385", "1385-2")
    T3-->>AI: è¦æ ¼: 45mm, GPS, å¿ƒç‡+è¡€æ°§

    AI->>T3: getModelSpecifications("PD-1385", "1385-3")
    T3-->>AI: è¦æ ¼: 41mm, GPS+Cellular

    AI->>T3: getModelSpecifications("PD-1385", "1385-4")
    T3-->>AI: è¦æ ¼: 45mm, å®Œæ•´åŠŸèƒ½

    Note over AI: æ•´åˆæ‰€æœ‰è³‡è¨Š<br/>ç”Ÿæˆå›æ‡‰
    AI-->>U: ğŸ“Š å®Œæ•´çš„ç”¢å“åˆ†æå ±å‘Š
```

### å·¥å…·éˆ vs å–®ä¸€å·¥å…·æ¯”è¼ƒ

```mermaid
graph TD
    subgraph "âŒ å–®ä¸€å¤§å·¥å…·"
        A1[ç”¨æˆ¶æŸ¥è©¢] --> B1[è¶…ç´šå·¥å…·]
        B1 --> C1[è¿”å›æ‰€æœ‰è³‡æ–™]
        C1 --> D1[AI åˆ†æ]

        style B1 fill:#ffcccc
    end

    subgraph "âœ… å·¥å…·éˆ"
        A2[ç”¨æˆ¶æŸ¥è©¢] --> B2[éŠ·å”®å·¥å…·]
        B2 --> C2{AI åˆ¤æ–·}
        C2 --> D2[ç”¢å“å·¥å…·]
        D2 --> E2{AI åˆ¤æ–·}
        E2 --> F2[è¦æ ¼å·¥å…·]
        F2 --> G2[AI æ•´åˆ]

        style C2 fill:#ccffcc
        style E2 fill:#ccffcc
    end
```

---

## ğŸ’» å¯¦æˆ°ï¼šå»ºç«‹å·¥å…·éˆç³»çµ±

### 1. ç”¢å“è©³æƒ…å·¥å…·

ç°¡åŒ–çš„ç”¢å“å‹è™ŸæŸ¥è©¢å·¥å…·ï¼š

```java
// å°æ‡‰ç¯„ä¾‹: chapter5-spring-ai-advanced/.../tools/ProductDetailsTools.java:77

@Component
@Slf4j
public class ProductDetailsTools {

    /**
     * ç”¢å“è©³æƒ…è³‡æ–™æ¨¡å‹
     */
    public record ProductDetail(
            String product,
            String productName,
            List<String> models,
            String category,
            String description
    ) {}

    /**
     * æ ¹æ“šç”¢å“ä»£ç¢¼ç²å–ç”¢å“å‹è™Ÿåˆ—è¡¨
     */
    @Tool(description = "Get detailed product information including all available models by product code or name. " +
          "Returns comprehensive product details with model specifications.")
    public ProductDetail getProductModels(String product) {
        log.info("æŸ¥è©¢ç”¢å“å‹è™Ÿï¼š{}", product);

        // æ¨¡æ“¬ä¼æ¥­ç”¢å“è³‡æ–™åº«
        Map<String, ProductDetail> productDatabase = Map.of(
            "PD-1405", new ProductDetail(
                "PD-1405",
                "æ™ºèƒ½æ‰‹æ©Ÿ Pro ç³»åˆ—",
                List.of("1405-001", "1405-002", "1405-003", "1405-004"),
                "æ™ºèƒ½æ‰‹æ©Ÿ",
                "é«˜ç«¯æ™ºèƒ½æ‰‹æ©Ÿç³»åˆ—ï¼Œæ”¯æ´ 5G å’Œ AI æ”å½±"
            ),
            "PD-1234", new ProductDetail(
                "PD-1234",
                "ç­†è¨˜å‹é›»è…¦ Ultra ç³»åˆ—",
                List.of("1234-1", "1234-2", "1234-3", "1234-4", "1234-5"),
                "ç­†è¨˜å‹é›»è…¦",
                "è¼•è–„é«˜æ•ˆèƒ½ç­†è¨˜å‹é›»è…¦ï¼Œé©åˆå•†å‹™å’Œå‰µä½œ"
            )
            // ... æ›´å¤šç”¢å“
        );

        return productDatabase.getOrDefault(product,
            new ProductDetail(product, "æœªçŸ¥ç”¢å“", List.of(), "æœªåˆ†é¡", "æŸ¥ç„¡æ­¤ç”¢å“"));
    }

    /**
     * ç”¢å“å‹è™Ÿè¦æ ¼è³‡æ–™æ¨¡å‹
     */
    public record ProductModel(
            String modelCode,
            String modelName,
            String specifications,
            String price,
            String availability
    ) {}

    /**
     * ç²å–ç‰¹å®šå‹è™Ÿçš„è©³ç´°è¦æ ¼
     */
    @Tool(description = "Get detailed specifications for a specific product model. " +
          "Returns comprehensive model information including price and availability.")
    public ProductModel getModelSpecifications(String productCode, String modelCode) {
        log.info("æŸ¥è©¢å‹è™Ÿè¦æ ¼ï¼š{}-{}", productCode, modelCode);

        // æ ¹æ“šç”¢å“é¡å‹ç”Ÿæˆè¦æ ¼è³‡è¨Š
        return switch (productCode) {
            case "PD-1405" -> new ProductModel(
                    modelCode,
                    "æ™ºèƒ½æ‰‹æ©Ÿ Pro " + modelCode,
                    generatePhoneSpecs(modelCode),
                    generatePrice("phone", modelCode),
                    "ç¾è²¨ä¾›æ‡‰"
            );
            case "PD-1234" -> new ProductModel(
                    modelCode,
                    "ç­†è¨˜å‹é›»è…¦ Ultra " + modelCode,
                    generateLaptopSpecs(modelCode),
                    generatePrice("laptop", modelCode),
                    "ç¾è²¨ä¾›æ‡‰"
            );
            default -> new ProductModel(
                    modelCode,
                    "ç”¢å“å‹è™Ÿ " + modelCode,
                    "æ¨™æº–è¦æ ¼",
                    "åƒ¹æ ¼é¢è­°",
                    "è«‹æ´½è©¢"
            );
        };
    }

    private String generatePhoneSpecs(String modelCode) {
        return switch (modelCode) {
            case "1405-001" -> "6.1å‹ OLED è¢å¹•, 128GB å„²å­˜, é›™é¡é ­";
            case "1405-002" -> "6.1å‹ OLED è¢å¹•, 256GB å„²å­˜, ä¸‰é¡é ­";
            case "1405-003" -> "6.7å‹ OLED è¢å¹•, 512GB å„²å­˜, ä¸‰é¡é ­ Pro";
            case "1405-004" -> "6.7å‹ OLED è¢å¹•, 1TB å„²å­˜, å››é¡é ­ Pro Max";
            default -> "æ¨™æº–æ™ºèƒ½æ‰‹æ©Ÿè¦æ ¼";
        };
    }

    private String generateLaptopSpecs(String modelCode) {
        return switch (modelCode) {
            case "1234-1" -> "13å‹, Intel i5, 8GB RAM, 256GB SSD";
            case "1234-2" -> "13å‹, Intel i7, 16GB RAM, 512GB SSD";
            case "1234-3" -> "15å‹, Intel i7, 16GB RAM, 1TB SSD";
            default -> "æ¨™æº–ç­†è¨˜å‹é›»è…¦è¦æ ¼";
        };
    }

    private String generatePrice(String category, String modelCode) {
        return switch (category) {
            case "phone" -> switch (modelCode) {
                case "1405-001" -> "NT$ 25,900";
                case "1405-002" -> "NT$ 29,900";
                case "1405-003" -> "NT$ 35,900";
                default -> "NT$ 25,000";
            };
            case "laptop" -> switch (modelCode) {
                case "1234-1" -> "NT$ 35,900";
                case "1234-2" -> "NT$ 45,900";
                case "1234-3" -> "NT$ 55,900";
                default -> "NT$ 40,000";
            };
            default -> "åƒ¹æ ¼é¢è­°";
        };
    }
}
```

### 2. å¢å¼·ç‰ˆéŠ·å”®å·¥å…·

ç°¡åŒ–çš„éŠ·å”®è³‡æ–™åˆ†æå·¥å…·ï¼š

```java
// å°æ‡‰ç¯„ä¾‹: chapter5-spring-ai-advanced/.../tools/EnhancedSalesTools.java:321

@Component
@Slf4j
public class EnhancedSalesTools {

    /**
     * ç”¢å“éŠ·å”®è³‡æ–™æ¨¡å‹
     */
    public record ProductSales(
            String product,
            String productName,
            int salesVolume,
            BigDecimal revenue,
            String category,
            double marketShare
    ) {}

    /**
     * éŠ·å”®æ’è¡Œè³‡æ–™æ¨¡å‹
     */
    public record SalesRanking(
            List<ProductSales> topProducts,
            ProductSales bestSeller,
            int totalVolume,
            BigDecimal totalRevenue,
            String analysisYear
    ) {}

    /**
     * ç²å–æŒ‡å®šå¹´ä»½çš„ç”¢å“éŠ·å”®æ’è¡Œ
     */
    @Tool(description = "Get comprehensive product sales data for a specific year. " +
          "Returns detailed sales information including volume, revenue, and market share.")
    public SalesRanking getProductSalesRanking(int year) {
        log.info("æŸ¥è©¢å¹´åº¦éŠ·å”®æ’è¡Œï¼š{}", year);

        List<ProductSales> salesData = getSalesDataByYear(year);

        if (salesData.isEmpty()) {
            return new SalesRanking(List.of(), null, 0, BigDecimal.ZERO, String.valueOf(year));
        }

        // è¨ˆç®—ç¸½éŠ·é‡å’Œç¸½ç‡Ÿæ”¶
        int totalVolume = salesData.stream()
                .mapToInt(ProductSales::salesVolume)
                .sum();

        BigDecimal totalRevenue = salesData.stream()
                .map(ProductSales::revenue)
                .reduce(BigDecimal.ZERO, BigDecimal::add);

        // æŒ‰éŠ·é‡æ’åº
        List<ProductSales> topProducts = salesData.stream()
                .sorted((p1, p2) -> Integer.compare(p2.salesVolume(), p1.salesVolume()))
                .collect(Collectors.toList());

        ProductSales bestSeller = topProducts.get(0);

        log.info("éŠ·å”®æ’è¡ŒæŸ¥è©¢å®Œæˆï¼š{}å¹´ï¼Œæœ€ä½³éŠ·å”®ç”¢å“ï¼š{}", year, bestSeller.productName());

        return new SalesRanking(
                topProducts,
                bestSeller,
                totalVolume,
                totalRevenue,
                String.valueOf(year)
        );
    }

    /**
     * æ¯”è¼ƒä¸åŒç”¢å“çš„éŠ·å”®è¡¨ç¾
     */
    @Tool(description = "Compare sales performance between multiple products in a specific year. " +
          "Returns detailed comparison with rankings and performance metrics.")
    public String compareProductPerformance(int year, List<String> products) {
        log.info("æ¯”è¼ƒç”¢å“éŠ·å”®è¡¨ç¾ï¼š{}å¹´ï¼Œç”¢å“ï¼š{}", year, products);

        List<ProductSales> allSales = getSalesDataByYear(year);

        List<ProductSales> targetProducts = allSales.stream()
                .filter(sale -> products.contains(sale.product()))
                .sorted((p1, p2) -> Integer.compare(p2.salesVolume(), p1.salesVolume()))
                .collect(Collectors.toList());

        if (targetProducts.isEmpty()) {
            return "æœªæ‰¾åˆ°æŒ‡å®šç”¢å“çš„éŠ·å”®è³‡æ–™";
        }

        StringBuilder comparison = new StringBuilder();
        comparison.append(String.format("ğŸ“Š %då¹´ç”¢å“éŠ·å”®è¡¨ç¾æ¯”è¼ƒ\n\n", year));

        for (int i = 0; i < targetProducts.size(); i++) {
            ProductSales product = targetProducts.get(i);
            comparison.append(String.format(
                    "%d. %s (%s)\n" +
                    "   éŠ·å”®é‡ï¼š%,d å°\n" +
                    "   ç‡Ÿæ”¶ï¼š%s\n" +
                    "   å¸‚å ´å æœ‰ç‡ï¼š%.2f%%\n\n",
                    i + 1,
                    product.productName(),
                    product.product(),
                    product.salesVolume(),
                    formatCurrency(product.revenue()),
                    product.marketShare()
            ));
        }

        return comparison.toString();
    }

    private List<ProductSales> getSalesDataByYear(int year) {
        // æ¨¡æ“¬ä¸åŒå¹´ä»½çš„éŠ·å”®è³‡æ–™
        Map<Integer, List<ProductSales>> salesDatabase = Map.of(
            2023, List.of(
                new ProductSales("PD-1385", "æ™ºèƒ½æ‰‹éŒ¶ç³»åˆ—", 15000,
                        new BigDecimal("300000000"), "ç©¿æˆ´è£ç½®", 35.7),
                new ProductSales("PD-1234", "ç­†è¨˜å‹é›»è…¦ Ultra ç³»åˆ—", 10000,
                        new BigDecimal("800000000"), "ç­†è¨˜å‹é›»è…¦", 23.8),
                new ProductSales("PD-1405", "æ™ºèƒ½æ‰‹æ©Ÿ Pro ç³»åˆ—", 8500,
                        new BigDecimal("425000000"), "æ™ºèƒ½æ‰‹æ©Ÿ", 20.2)
            ),
            2024, List.of(
                new ProductSales("PD-1405", "æ™ºèƒ½æ‰‹æ©Ÿ Pro ç³»åˆ—", 18500,
                        new BigDecimal("925000000"), "æ™ºèƒ½æ‰‹æ©Ÿ", 28.5),
                new ProductSales("PD-1385", "æ™ºèƒ½æ‰‹éŒ¶ç³»åˆ—", 17000,
                        new BigDecimal("510000000"), "ç©¿æˆ´è£ç½®", 26.2),
                new ProductSales("PD-1234", "ç­†è¨˜å‹é›»è…¦ Ultra ç³»åˆ—", 12000,
                        new BigDecimal("960000000"), "ç­†è¨˜å‹é›»è…¦", 18.5)
            )
        );

        return salesDatabase.getOrDefault(year, List.of());
    }

    private String formatCurrency(BigDecimal amount) {
        if (amount.compareTo(new BigDecimal("100000000")) >= 0) {
            return String.format("NT$ %.1få„„",
                    amount.divide(new BigDecimal("100000000"), 1, RoundingMode.HALF_UP).doubleValue());
        }
        return String.format("NT$ %,d", amount.intValue());
    }
}
```

### 3. å·¥å…·éˆå”èª¿é…ç½®

```java
// å°æ‡‰ç¯„ä¾‹: chapter5-spring-ai-advanced/.../config/AdvancedAiConfig.java:532

@Configuration
@RequiredArgsConstructor
public class AdvancedAiConfig {

    private final ProductDetailsTools productDetailsTools;
    private final EnhancedSalesTools enhancedSalesTools;
    private final DateTimeTools dateTimeTools;
    private final CalculatorTools calculatorTools;

    /**
     * ä¼æ¥­ç´šå·¥å…·éˆ ChatClient
     * æ”¯æ´è¤‡é›œçš„å¤šæ­¥é©Ÿå·¥å…·èª¿ç”¨
     */
    @Bean
    public ChatClient toolChainChatClient(ChatModel chatModel) {
        return ChatClient.builder(chatModel)
                .defaultTools(
                    enhancedSalesTools,     // éŠ·å”®è³‡æ–™åˆ†æå·¥å…·
                    productDetailsTools,    // ç”¢å“è©³æƒ…å·¥å…·
                    calculatorTools,        // è¨ˆç®—å·¥å…·
                    dateTimeTools          // æ™‚é–“å·¥å…·
                )
                .defaultSystem("""
                    ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„ä¼æ¥­è³‡æ–™åˆ†æå°ˆå®¶ï¼Œæ“…é•·ä½¿ç”¨å¤šç¨®å·¥å…·é€²è¡Œæ·±åº¦åˆ†æã€‚

                    å·¥å…·ä½¿ç”¨ç­–ç•¥ï¼š
                    1. æ ¹æ“šç”¨æˆ¶æŸ¥è©¢è‡ªå‹•é¸æ“‡åˆé©çš„å·¥å…·çµ„åˆ
                    2. æŒ‰é‚è¼¯é †åºèª¿ç”¨å·¥å…·ï¼ˆå…ˆç²å–åŸºç¤è³‡æ–™ï¼Œå†é€²è¡Œè©³ç´°åˆ†æï¼‰
                    3. å……åˆ†åˆ©ç”¨å·¥å…·éˆçš„å„ªå‹¢ï¼Œé¿å…ä¸€æ¬¡æ€§ç²å–éå¤šè³‡æ–™
                    4. æä¾›æ·±å…¥çš„åˆ†ææ´å¯Ÿå’Œå•†æ¥­å»ºè­°

                    å›ç­”é¢¨æ ¼ï¼š
                    - ä½¿ç”¨å°ˆæ¥­ä½†æ˜“æ‡‚çš„èªè¨€
                    - æä¾›çµæ§‹åŒ–çš„åˆ†æçµæœ
                    - åŒ…å«å…·é«”çš„æ•¸æ“šå’Œæ´å¯Ÿ
                    - çµ¦å‡ºå¯¦ç”¨çš„å•†æ¥­å»ºè­°
                    """)
                .build();
    }
}
```

---

## ğŸ¬ å¯¦éš›æ‡‰ç”¨å ´æ™¯

### å ´æ™¯ï¼šè¤‡é›œéŠ·å”®åˆ†æ

**ç”¨æˆ¶æŸ¥è©¢**: ã€Œè«‹å‘Šè¨´æˆ‘ 2023 å¹´æœ€ç†±éŠ·çš„ç”¢å“ï¼Œä¸¦åˆ—å‡ºè©²ç”¢å“æ‰€æœ‰å‹è™Ÿçš„è©³ç´°è¦æ ¼å’Œåƒ¹æ ¼ã€

**å·¥å…·éˆåŸ·è¡Œæµç¨‹**:

```mermaid
graph TD
    A[ç”¨æˆ¶æŸ¥è©¢] --> B[ğŸ” æŸ¥è©¢ 2023 å¹´éŠ·å”®æ’è¡Œ]
    B --> C{AI åˆ†æçµæœ}
    C --> D[ğŸ“Š è­˜åˆ¥: PD-1385 æ™ºèƒ½æ‰‹éŒ¶]
    D --> E[ğŸ“‹ æŸ¥è©¢ PD-1385 å‹è™Ÿåˆ—è¡¨]
    E --> F[âœ… ç²å¾— 4 å€‹å‹è™Ÿ]
    F --> G[ğŸ” æŸ¥è©¢å‹è™Ÿ 1385-1 è¦æ ¼]
    F --> H[ğŸ” æŸ¥è©¢å‹è™Ÿ 1385-2 è¦æ ¼]
    F --> I[ğŸ” æŸ¥è©¢å‹è™Ÿ 1385-3 è¦æ ¼]
    F --> J[ğŸ” æŸ¥è©¢å‹è™Ÿ 1385-4 è¦æ ¼]
    G --> K[ğŸ§  AI æ•´åˆæ‰€æœ‰è³‡è¨Š]
    H --> K
    I --> K
    J --> K
    K --> L[ğŸ“„ ç”Ÿæˆå®Œæ•´åˆ†æå ±å‘Š]

    style B fill:#e1f5ff
    style E fill:#fff4e6
    style G fill:#f3e5f5
    style H fill:#f3e5f5
    style I fill:#f3e5f5
    style J fill:#f3e5f5
    style K fill:#e8f5e9
```

**AI å›æ‡‰ç¯„ä¾‹**:

```
ğŸ“Š **2023å¹´æœ€ç†±éŠ·ç”¢å“åˆ†æå ±å‘Š**

ğŸ† **æœ€ä½³éŠ·å”®ç”¢å“**
- ç”¢å“ï¼šPD-1385 æ™ºèƒ½æ‰‹éŒ¶ç³»åˆ—
- éŠ·å”®é‡ï¼š15,000 å°
- ç‡Ÿæ”¶ï¼šNT$ 3.0å„„
- å¸‚å ´å æœ‰ç‡ï¼š35.7%

ğŸ“± **ç”¢å“å‹è™Ÿå®Œæ•´è³‡è¨Š**

**1. æ™ºèƒ½æ‰‹éŒ¶ 1385-1**
- è¦æ ¼ï¼š41mm, GPS, å¿ƒç‡ç›£æ¸¬
- åƒ¹æ ¼ï¼šNT$ 12,900
- å®šä½ï¼šå…¥é–€æ¬¾ï¼Œé©åˆæ—¥å¸¸ä½¿ç”¨

**2. æ™ºèƒ½æ‰‹éŒ¶ 1385-2**
- è¦æ ¼ï¼š45mm, GPS, å¿ƒç‡ç›£æ¸¬, è¡€æ°§æª¢æ¸¬
- åƒ¹æ ¼ï¼šNT$ 15,900
- å®šä½ï¼šé€²éšæ¬¾ï¼Œå¢åŠ å¥åº·ç›£æ¸¬åŠŸèƒ½

**3. æ™ºèƒ½æ‰‹éŒ¶ 1385-3**
- è¦æ ¼ï¼š41mm, GPS+Cellular, å¿ƒç‡ç›£æ¸¬, è¡€æ°§æª¢æ¸¬
- åƒ¹æ ¼ï¼šNT$ 18,900
- å®šä½ï¼šç¨ç«‹é€šè¨Šæ¬¾ï¼Œæ”¯æ´ç¨ç«‹é€šè©±

**4. æ™ºèƒ½æ‰‹éŒ¶ 1385-4**
- è¦æ ¼ï¼š45mm, GPS+Cellular, å¿ƒç‡ç›£æ¸¬, è¡€æ°§æª¢æ¸¬, ECG
- åƒ¹æ ¼ï¼šNT$ 22,900
- å®šä½ï¼šæ——è‰¦æ¬¾ï¼Œå®Œæ•´å¥åº·ç›£æ¸¬åŠŸèƒ½

ğŸ’¡ **å•†æ¥­æ´å¯Ÿ**
- æ™ºèƒ½æ‰‹éŒ¶å¸‚å ´éœ€æ±‚å¼·å‹ï¼Œå å…¬å¸ç¸½éŠ·é‡è¶…é1/3
- ç”¢å“ç·šå®Œæ•´ï¼Œå¾å…¥é–€åˆ°æ——è‰¦éƒ½æœ‰è¦†è“‹
- å¥åº·ç›£æ¸¬åŠŸèƒ½æ˜¯ä¸»è¦è³£é»
- å»ºè­°åŠ å¼·é‹å‹•å’Œå¥åº·ç”Ÿæ…‹ç³»çµ±æ•´åˆ
```

---

## ğŸ’» æ§åˆ¶å™¨å¯¦ç¾

ç°¡åŒ–çš„å·¥å…·éˆæ§åˆ¶å™¨ï¼š

```java
// å°æ‡‰ç¯„ä¾‹: chapter5-spring-ai-advanced/.../controller/ToolChainController.java:611

@RestController
@RequestMapping("/api/tool-chain")
@RequiredArgsConstructor
@Slf4j
public class ToolChainController {

    private final ChatClient toolChainChatClient;

    /**
     * è¤‡é›œå·¥å…·éˆæŸ¥è©¢
     */
    @GetMapping("/complex-query")
    public String complexQuery(@RequestParam String prompt) {
        log.info("æ”¶åˆ°è¤‡é›œå·¥å…·éˆæŸ¥è©¢ï¼š{}", prompt);

        long startTime = System.currentTimeMillis();

        String response = toolChainChatClient
                .prompt(prompt)
                .call()
                .content();

        long endTime = System.currentTimeMillis();

        log.info("è¤‡é›œæŸ¥è©¢å®Œæˆï¼Œè€—æ™‚ï¼š{}ms", endTime - startTime);

        return response;
    }

    /**
     * ç”¢å“æ·±åº¦åˆ†æ
     */
    @PostMapping("/product-analysis")
    public ProductAnalysisResponse productAnalysis(@RequestBody ProductAnalysisRequest request) {
        log.info("ç”¢å“æ·±åº¦åˆ†æè«‹æ±‚ï¼š{}", request);

        long startTime = System.currentTimeMillis();

        // æ§‹å»ºåˆ†ææç¤ºè©
        String prompt = buildAnalysisPrompt(request);

        String analysis = toolChainChatClient
                .prompt(prompt)
                .call()
                .content();

        long endTime = System.currentTimeMillis();

        return ProductAnalysisResponse.builder()
                .success(true)
                .productCode(request.getProductCode())
                .analysisType(request.getAnalysisType())
                .analysis(analysis)
                .executionTime(endTime - startTime)
                .timestamp(LocalDateTime.now())
                .build();
    }

    private String buildAnalysisPrompt(ProductAnalysisRequest request) {
        StringBuilder prompt = new StringBuilder();

        prompt.append("è«‹é€²è¡Œæ·±åº¦ç”¢å“åˆ†æï¼š\n");
        prompt.append("ç”¢å“ä»£ç¢¼ï¼š").append(request.getProductCode()).append("\n");
        prompt.append("åˆ†æé¡å‹ï¼š").append(request.getAnalysisType()).append("\n");

        if (request.getYear() != null) {
            prompt.append("åˆ†æå¹´ä»½ï¼š").append(request.getYear()).append("\n");
        }

        return prompt.toString();
    }
}
```

---

## ğŸ“ é‡é»å›é¡§

### å·¥å…·éˆæ ¸å¿ƒæ¦‚å¿µ

âœ… **è‡ªå‹•éˆå¼èª¿ç”¨** - AI è‡ªå‹•åˆ¤æ–·éœ€è¦èª¿ç”¨å“ªäº›å·¥å…·
âœ… **è³‡æ–™æµè½‰** - å‰ä¸€å€‹å·¥å…·çš„è¼¸å‡ºæˆç‚ºä¸‹ä¸€å€‹å·¥å…·çš„è¼¸å…¥
âœ… **æ™ºèƒ½æ±ºç­–** - AI æ ¹æ“šä¸­é–“çµæœå‹•æ…‹èª¿æ•´ç­–ç•¥
âœ… **è·è²¬åˆ†é›¢** - æ¯å€‹å·¥å…·å°ˆæ³¨æ–¼ç‰¹å®šåŠŸèƒ½

### è¨­è¨ˆåŸå‰‡

| åŸå‰‡ | èªªæ˜ | å¯¦è¸å»ºè­° |
|------|------|----------|
| **å–®ä¸€è·è²¬** | æ¯å€‹å·¥å…·å°ˆæ³¨ä¸€ä»¶äº‹ | é¿å…å·¥å…·åŠŸèƒ½é‡ç–Š |
| **æ¸…æ™°æè¿°** | å·¥å…·æè¿°è¦ç²¾ç¢º | ä½¿ç”¨ @Tool description |
| **éŒ¯èª¤è™•ç†** | å„ªé›…çš„é™ç´šæ©Ÿåˆ¶ | è¿”å›å‹å–„çš„éŒ¯èª¤è¨Šæ¯ |
| **æ•ˆèƒ½å„ªåŒ–** | é¿å…ä¸å¿…è¦èª¿ç”¨ | è¨­è¨ˆåˆç†çš„è³‡æ–™æµè½‰ |

### ä¼æ¥­æ‡‰ç”¨åƒ¹å€¼

**1. é™ä½é–‹ç™¼æˆæœ¬**
- ğŸ”§ æ¨¡çµ„åŒ–è¨­è¨ˆï¼šå·¥å…·å¯é‡è¤‡ä½¿ç”¨å’Œçµ„åˆ
- âš¡ å¿«é€Ÿé–‹ç™¼ï¼šæ–°åŠŸèƒ½é€šéå·¥å…·çµ„åˆå¿«é€Ÿå¯¦ç¾
- ğŸ› ï¸ æ˜“æ–¼ç¶­è­·ï¼šå–®ä¸€å·¥å…·çš„ä¿®æ”¹ä¸å½±éŸ¿å…¶ä»–åŠŸèƒ½

**2. æå‡ç”¨æˆ¶é«”é©—**
- ğŸ—£ï¸ è‡ªç„¶äº’å‹•ï¼šç”¨æˆ¶ç”¨è‡ªç„¶èªè¨€æè¿°è¤‡é›œéœ€æ±‚
- ğŸ¯ ç²¾æº–å›æ‡‰ï¼šAI è‡ªå‹•é¸æ“‡æœ€ä½³å·¥å…·çµ„åˆ
- ğŸ“Š æ·±åº¦åˆ†æï¼šæä¾›æ¯”å‚³çµ± BI æ›´æ·±å…¥çš„æ´å¯Ÿ

**3. æ“´å±•æ¥­å‹™èƒ½åŠ›**
- ğŸš€ ç„¡é™æ“´å±•ï¼šæ–°å·¥å…·å¯ç„¡ç¸«æ•´åˆåˆ°ç¾æœ‰ç³»çµ±
- ğŸ”„ éˆæ´»çµ„åˆï¼šæ ¹æ“šæ¥­å‹™éœ€æ±‚å‹•æ…‹çµ„åˆå·¥å…·
- ğŸ’¡ å‰µæ–°æ‡‰ç”¨ï¼šAI å¯ç™¼ç¾äººé¡æœªæƒ³åˆ°çš„å·¥å…·çµ„åˆæ–¹å¼

---

## ğŸš€ ä¸‹ä¸€æ­¥

å®Œæˆæœ¬ç¯€å¾Œï¼Œæ‚¨å·²ç¶“æŒæ¡äº†å·¥å…·éˆçš„ç®¡ç†æŠ€è¡“ã€‚æ¥ä¸‹ä¾†éœ€è¦æ•´åˆçœŸå¯¦çš„å¤–éƒ¨æœå‹™ï¼š

**çœŸå¯¦ API æœå‹™æ•´åˆ**
- å­¸ç¿’æ•´åˆçœŸå¯¦ä¸–ç•Œçš„ç¬¬ä¸‰æ–¹ APIï¼ˆå¤©æ°£ã€åœ°åœ–ã€ç¿»è­¯ç­‰ï¼‰
- æŒæ¡ API é‡‘é‘°ç®¡ç†å’Œå®‰å…¨æ€§æœ€ä½³å¯¦è¸
- ç†è§£å¦‚ä½•è™•ç† API é™æµã€é…é¡å’Œè²»ç”¨æ§åˆ¶
- å­¸ç¿’è¨­è¨ˆç©©å¥çš„éŒ¯èª¤è™•ç†å’Œé™ç´šç­–ç•¥
- æŒæ¡ API å›æ‡‰çš„å¿«å–å’Œæ•ˆèƒ½å„ªåŒ–

**çµæ§‹åŒ–è³‡æ–™è½‰æ›**
- å­¸ç¿’è®“ AI è¼¸å‡ºçµæ§‹åŒ–çš„è³‡æ–™æ ¼å¼ï¼ˆJSONã€XMLï¼‰
- æŒæ¡ä½¿ç”¨ BeanOutputConverter é€²è¡Œè³‡æ–™è½‰æ›
- ç†è§£å¦‚ä½•å®šç¾©å’Œé©—è­‰è¼¸å‡ºè³‡æ–™çš„çµæ§‹
- å­¸ç¿’è™•ç† AI è¼¸å‡ºçš„è§£æéŒ¯èª¤å’Œæ ¼å¼å•é¡Œ
- æŒæ¡çµæ§‹åŒ–è¼¸å‡ºåœ¨å¯¦éš›æ‡‰ç”¨ä¸­çš„ä½¿ç”¨å ´æ™¯

å®Œæˆç¬¬äº”ç« å¾Œï¼Œæ‚¨å°‡å…·å‚™é–‹ç™¼å®Œæ•´ AI æ‡‰ç”¨çš„å…¨æ–¹ä½èƒ½åŠ›ï¼Œç‚ºé€²å…¥è¨˜æ†¶ç³»çµ±å’Œ RAG æŠ€è¡“åšå¥½æº–å‚™ã€‚

