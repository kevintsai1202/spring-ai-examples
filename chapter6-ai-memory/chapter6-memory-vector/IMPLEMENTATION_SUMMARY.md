# Chapter 6 - Memory Vector å¯¦ç¾ç¸½çµ

## ğŸ“Š å°ˆæ¡ˆçµ±è¨ˆ

### ç¨‹å¼ç¢¼çµ±è¨ˆ

| é¡åˆ¥ | æ•¸é‡ |
|------|------|
| Java æºæ–‡ä»¶ | 20+ |
| é…ç½®æ–‡ä»¶ | 4 |
| æ¸¬è©¦æ–‡ä»¶ | 2+ |
| æ–‡æª”æ–‡ä»¶ | 5 |
| **ç¸½è¨ˆ** | **31+** |

### ç¨‹å¼ç¢¼è¡Œæ•¸ (ä¼°ç®—)

- Java ä»£ç¢¼: ~3000+ è¡Œ
- é…ç½®æ–‡ä»¶: ~300 è¡Œ
- æ–‡æª”: ~2000+ è¡Œ
- **ç¸½è¨ˆ**: ~5300+ è¡Œ

## ğŸ—ï¸ æ¶æ§‹å¯¦ç¾

### 1. é…ç½®å±¤ (Config Layer)

#### Neo4jVectorStoreConfig.java
- âœ… Neo4j Driver Bean é…ç½®
- âœ… OpenAI EmbeddingModel Bean
- âœ… Neo4jVectorStore Bean
- âœ… å‘é‡ç´¢å¼•è‡ªå‹•åˆå§‹åŒ–
- âœ… é…ç½®å±¬æ€§ç¶å®š

**é—œéµå¯¦ç¾**:
```java
@Bean
public VectorStore vectorStore(Driver driver, EmbeddingModel embeddingModel) {
    return Neo4jVectorStore.builder(driver, embeddingModel)
        .databaseName("neo4j")
        .distanceType(Neo4jDistanceType.COSINE)
        .embeddingDimension(1536)
        .initializeSchema(true)
        .build();
}
```

#### MemoryConfig.java
- âœ… çŸ­æœŸè¨˜æ†¶ Bean (InMemoryChatMemory)
- âœ… è¨˜æ†¶é…ç½®å±¬æ€§
- âœ… åŒæ­¥ç­–ç•¥é…ç½®

#### ChatClientConfig.java
- âœ… ChatClient.Builder Bean

### 2. æœå‹™å±¤ (Service Layer)

#### HybridMemoryService.java
**åŠŸèƒ½**:
- âœ… æ··åˆè¨˜æ†¶å°è©±
- âœ… çŸ­æœŸè¨˜æ†¶å°è©±
- âœ… é•·æœŸè¨˜æ†¶å°è©±
- âœ… æ™ºèƒ½ç­–ç•¥é¸æ“‡
- âœ… è¨˜æ†¶ç­–ç•¥æ¨æ–·

**æ ¸å¿ƒæ–¹æ³•**:
- `chatWithHybridMemory()` - åŒæ™‚ä½¿ç”¨å…©ç¨® Advisor
- `chatWithSmartStrategy()` - é—œéµè©æª¢æ¸¬è‡ªå‹•é¸ç­–ç•¥
- `determineStrategy()` - ç­–ç•¥æ±ºç­–é‚è¼¯

#### MemorySyncService.java
**åŠŸèƒ½**:
- âœ… å®šæ™‚è‡ªå‹•åŒæ­¥ (@Scheduled)
- âœ… æ‰‹å‹•è§¸ç™¼åŒæ­¥
- âœ… è¨Šæ¯è½‰ Document è½‰æ›
- âœ… æ´»èºå°è©±ç®¡ç†
- âœ… åŒæ­¥ç‹€æ…‹è¿½è¹¤

**æ ¸å¿ƒæ–¹æ³•**:
- `autoSyncMemories()` - æ¯5åˆ†é˜åŸ·è¡Œ
- `syncConversationMemory()` - å–®å°è©±åŒæ­¥
- `convertMessagesToDocuments()` - è¨Šæ¯è½‰æ›

#### SmartMemoryRetrievalService.java
**åŠŸèƒ½**:
- âœ… çŸ­æœŸè¨˜æ†¶æª¢ç´¢
- âœ… é•·æœŸè¨˜æ†¶å‘é‡æœå°‹
- âœ… è¨˜æ†¶èåˆå’Œæ’åº
- âœ… ç›¸é—œæ€§åˆ†æ•¸è¨ˆç®—

**æ ¸å¿ƒæ–¹æ³•**:
- `retrieveRelevantMemories()` - æ··åˆæª¢ç´¢
- `fuseAndRankMemories()` - è¨˜æ†¶èåˆ
- `calculateShortTermRelevance()` - ç›¸é—œæ€§è¨ˆç®—

#### MemoryAnalyticsService.java
**åŠŸèƒ½**:
- âœ… è¨˜æ†¶çµ±è¨ˆåˆ†æ
- âœ… å¥åº·åˆ†æ•¸è¨ˆç®—
- âœ… åŒæ­¥ç‹€æ…‹ç›£æ§
- âœ… Micrometer æŒ‡æ¨™é›†æˆ

**æ ¸å¿ƒæ–¹æ³•**:
- `getConversationAnalytics()` - ç¶œåˆåˆ†æ
- `calculateHealthScore()` - å¥åº·è©•åˆ†
- `recordMemoryOperation()` - æŒ‡æ¨™è¨˜éŒ„

### 3. æ§åˆ¶å™¨å±¤ (Controller Layer)

#### VectorChatController.java
**REST ç«¯é»**:
- âœ… `POST /{id}/hybrid` - æ··åˆè¨˜æ†¶å°è©±
- âœ… `POST /{id}/short-term` - çŸ­æœŸè¨˜æ†¶å°è©±
- âœ… `POST /{id}/long-term` - é•·æœŸè¨˜æ†¶å°è©±
- âœ… `POST /{id}/smart` - æ™ºèƒ½ç­–ç•¥å°è©±
- âœ… `GET /health` - å¥åº·æª¢æŸ¥

#### MemoryManagementController.java
**REST ç«¯é»**:
- âœ… `GET /analytics/{id}` - è¨˜æ†¶åˆ†æ
- âœ… `POST /sync/{id}` - æ‰‹å‹•åŒæ­¥
- âœ… `POST /retrieve/{id}` - æª¢ç´¢è¨˜æ†¶
- âœ… `DELETE /{id}` - åˆªé™¤è¨˜æ†¶
- âœ… `GET /conversations` - æ´»èºå°è©±åˆ—è¡¨

### 4. æ¨¡å‹å±¤ (Model Layer)

#### DTO é¡åˆ¥
- âœ… `VectorChatRequest` - å°è©±è«‹æ±‚
- âœ… `VectorChatResponse` - å°è©±éŸ¿æ‡‰
- âœ… `MemoryRetrievalResult` - æª¢ç´¢çµæœ
- âœ… `MemoryAnalytics` - åˆ†æçµæœ

#### æšèˆ‰é¡åˆ¥
- âœ… `MemoryType` - SHORT_TERM / LONG_TERM
- âœ… `MemoryStrategy` - ç­–ç•¥é¡å‹

#### æ•¸æ“šæ¨¡å‹
- âœ… `MemoryItem` - çµ±ä¸€è¨˜æ†¶é …ç›®

### 5. ç•°å¸¸è™•ç† (Exception Handling)

#### GlobalExceptionHandler.java
- âœ… é©—è­‰ç•°å¸¸è™•ç†
- âœ… é€šç”¨ç•°å¸¸è™•ç†
- âœ… çµ±ä¸€éŒ¯èª¤éŸ¿æ‡‰æ ¼å¼

## ğŸ”§ é…ç½®æ–‡ä»¶

### application.yml
- âœ… Spring AI OpenAI é…ç½®
- âœ… Neo4j é€£æ¥é…ç½®
- âœ… å‘é‡å­˜å„²é…ç½®
- âœ… è¨˜æ†¶ç³»çµ±é…ç½®
- âœ… åŒæ­¥ç­–ç•¥é…ç½®
- âœ… æª¢ç´¢ç­–ç•¥é…ç½®

### application-dev.yml
- âœ… é–‹ç™¼ç’°å¢ƒå°ˆç”¨é…ç½®
- âœ… èª¿è©¦æ—¥èªŒç´šåˆ¥
- âœ… å¿«é€ŸåŒæ­¥é–“éš”

### application-prod.yml
- âœ… ç”Ÿç”¢ç’°å¢ƒé…ç½®
- âœ… æ€§èƒ½å„ªåŒ–åƒæ•¸
- âœ… æ—¥èªŒæ–‡ä»¶é…ç½®

### application-test.yml
- âœ… æ¸¬è©¦ç’°å¢ƒé…ç½®
- âœ… Mock é…ç½®

## ğŸ³ Docker é…ç½®

### docker-compose.yml
- âœ… Spring AI æ‡‰ç”¨å®¹å™¨
- âœ… Neo4j å‘é‡è³‡æ–™åº«å®¹å™¨
- âœ… ç¶²çµ¡é…ç½®
- âœ… å·ç®¡ç†
- âœ… å¥åº·æª¢æŸ¥

### Dockerfile
- âœ… å¤šéšæ®µæ§‹å»º
- âœ… Java 21 é‹è¡Œç’°å¢ƒ
- âœ… é root ç”¨æˆ¶
- âœ… å¥åº·æª¢æŸ¥ç«¯é»

## ğŸ§ª æ¸¬è©¦å¯¦ç¾

### ApplicationTests.java
- âœ… ä¸Šä¸‹æ–‡åŠ è¼‰æ¸¬è©¦

### test-api.ps1
- âœ… å®Œæ•´çš„ API è‡ªå‹•åŒ–æ¸¬è©¦è…³æœ¬
- âœ… 9 å€‹æ¸¬è©¦å ´æ™¯
- âœ… å½©è‰²è¼¸å‡º
- âœ… æ¸…ç†é¸é …

## ğŸ“š æ–‡æª”

### README.md
- âœ… å°ˆæ¡ˆæ¦‚è¿°
- âœ… å¿«é€Ÿé–‹å§‹æŒ‡å—
- âœ… API ä½¿ç”¨ç¯„ä¾‹
- âœ… æ¶æ§‹èªªæ˜
- âœ… é…ç½®èªªæ˜
- âœ… æ•…éšœæ’é™¤

### TEST_GUIDE.md
- âœ… æ¸¬è©¦ç’°å¢ƒæº–å‚™
- âœ… æ‰‹å‹•æ¸¬è©¦æ­¥é©Ÿ
- âœ… é©—è­‰æ–¹æ³•
- âœ… å•é¡Œæ’æŸ¥
- âœ… æ¸¬è©¦æª¢æŸ¥æ¸…å–®

### VECTOR_DATABASE_GUIDE.md
- âœ… å‘é‡è³‡æ–™åº«é¸æ“‡æŒ‡å—
- âœ… Neo4j é…ç½®
- âœ… å¤šç¨®å‘é‡è³‡æ–™åº«æ¯”è¼ƒ

### spec.md
- âœ… å®Œæ•´è¦æ ¼æ–‡æª”
- âœ… æ¶æ§‹åœ–
- âœ… æµç¨‹åœ–
- âœ… é¡åˆ¥åœ–
- âœ… åºåˆ—åœ–

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½å¯¦ç¾

### 1. å‘é‡è¨˜æ†¶æ•´åˆ

âœ… **Spring AI Neo4jVectorStore**
- è‡ªå‹• Schema åˆå§‹åŒ–
- COSINE è·é›¢è¨ˆç®—
- 1536 ç¶­å‘é‡
- å…ƒæ•¸æ“šéæ¿¾

âœ… **OpenAI Embedding**
- text-embedding-3-small æ¨¡å‹
- è‡ªå‹•å‘é‡åŒ–æ–‡æª”

### 2. è¨˜æ†¶ç­–ç•¥

âœ… **çŸ­æœŸè¨˜æ†¶** (InMemoryChatMemory)
- æœ€è¿‘ 20 æ¢è¨Šæ¯
- å¿«é€Ÿè¨ªå•
- ç·šç¨‹å®‰å…¨

âœ… **é•·æœŸè¨˜æ†¶** (Neo4j VectorStore)
- èªç¾©ç›¸ä¼¼æ€§æœå°‹
- ç›¸ä¼¼æ€§é–¾å€¼: 0.75
- Top-K: 10

âœ… **æ··åˆè¨˜æ†¶**
- åŒæ™‚ä½¿ç”¨å…©ç¨® Advisor
- çŸ­æœŸæ¬Šé‡ 60%, é•·æœŸæ¬Šé‡ 40%
- ç›¸é—œæ€§æ’åº

âœ… **æ™ºèƒ½ç­–ç•¥**
- é—œéµè©æª¢æ¸¬: "å‰›æ‰"ã€"ä¹‹å‰"ã€"è¨˜å¾—"
- è‡ªå‹•ç­–ç•¥é¸æ“‡
- ç”¨æˆ¶å¯é¡¯å¼æŒ‡å®šç­–ç•¥

### 3. è¨˜æ†¶åŒæ­¥

âœ… **è‡ªå‹•åŒæ­¥**
- @Scheduled å®šæ™‚ä»»å‹™
- æ¯5åˆ†é˜åŸ·è¡Œ
- è¨Šæ¯æ•¸é‡é–¾å€¼: 10

âœ… **æ‰¹é‡è™•ç†**
- æ‰¹é‡è½‰æ› Message â†’ Document
- è‡ªå‹•å‘é‡åŒ–
- å…ƒæ•¸æ“šä¿ç•™

âœ… **åŒæ­¥ç‹€æ…‹ç®¡ç†**
- æœ€å¾ŒåŒæ­¥æ™‚é–“è¿½è¹¤
- æ´»èºå°è©±é›†åˆ
- åŒæ­¥è¨˜éŒ„æ¸…ç†

### 4. æ™ºèƒ½æª¢ç´¢

âœ… **å¤šå±¤æ¬¡æª¢ç´¢**
- çŸ­æœŸè¨˜æ†¶: é †åºå­˜å–
- é•·æœŸè¨˜æ†¶: å‘é‡æœå°‹
- èåˆæª¢ç´¢: çµ±ä¸€æ ¼å¼

âœ… **ç›¸é—œæ€§è¨ˆç®—**
- ä½ç½®æ¬Šé‡
- å…§å®¹åŒ¹é…
- å‘é‡ç›¸ä¼¼åº¦
- ç¶œåˆè©•åˆ†

âœ… **æª¢ç´¢å„ªåŒ–**
- å…ƒæ•¸æ“šéæ¿¾ (conversationId)
- Top-K é™åˆ¶
- ç›¸ä¼¼æ€§é–¾å€¼éæ¿¾

### 5. è¨˜æ†¶åˆ†æ

âœ… **çµ±è¨ˆåˆ†æ**
- çŸ­æœŸ/é•·æœŸè¨˜æ†¶æ•¸é‡
- ç¸½å­—ç¬¦æ•¸
- å¹³å‡ç›¸é—œæ€§åˆ†æ•¸

âœ… **å¥åº·è©•åˆ†**
- è¨˜æ†¶æ•¸é‡å¹³è¡¡
- åŒæ­¥æ™‚æ•ˆæ€§
- ç›¸é—œæ€§å“è³ª
- 0-100 åˆ†åˆ¶

âœ… **ç›£æ§æŒ‡æ¨™**
- Micrometer é›†æˆ
- æ“ä½œè¨ˆæ•¸
- æª¢ç´¢æ™‚é–“

## ğŸš€ æŠ€è¡“äº®é»

### 1. Spring AI Advisor éˆ

```java
chatClient.prompt()
    .user(userMessage)
    .advisors(
        MessageChatMemoryAdvisor.builder(shortTermMemory).build(),
        VectorStoreChatMemoryAdvisor.builder(vectorStore).build()
    )
    .call()
    .content();
```

**ç‰¹é»**:
- éˆå¼èª¿ç”¨
- è‡ªå‹•è¨˜æ†¶æ³¨å…¥
- é€æ˜åŒ–è™•ç†

### 2. å‘é‡æœå°‹éæ¿¾

```java
SearchRequest.builder()
    .query(query)
    .topK(10)
    .similarityThreshold(0.75)
    .filterExpression("conversationId == '" + conversationId + "'")
    .build()
```

**ç‰¹é»**:
- å…ƒæ•¸æ“šéæ¿¾
- ç›¸ä¼¼æ€§é–¾å€¼
- Top-K é™åˆ¶

### 3. å®šæ™‚åŒæ­¥

```java
@Scheduled(fixedDelayString = "${memory.sync.interval:300000}")
public void autoSyncMemories() {
    // è‡ªå‹•åŒæ­¥é‚è¼¯
}
```

**ç‰¹é»**:
- å¯é…ç½®é–“éš”
- æ‰¹é‡è™•ç†
- ç•°å¸¸å®¹éŒ¯

### 4. è¨˜æ†¶èåˆç®—æ³•

```java
// çŸ­æœŸè¨˜æ†¶æ¬Šé‡
double positionWeight = 1.0 - (index * 0.05);

// ç¶œåˆåˆ†æ•¸
double score = (positionWeight * 0.6) + (contentRelevance * 0.4);
```

**ç‰¹é»**:
- ä½ç½®è¡°æ¸›
- å…§å®¹ç›¸é—œæ€§
- å¯èª¿æ¬Šé‡

## ğŸ“Š æ€§èƒ½æŒ‡æ¨™

### é æœŸæ€§èƒ½

| æŒ‡æ¨™ | ç›®æ¨™å€¼ |
|------|--------|
| API éŸ¿æ‡‰æ™‚é–“ | < 3ç§’ |
| è¨˜æ†¶æª¢ç´¢æ™‚é–“ | < 500ms |
| å‘é‡æœå°‹æ™‚é–“ | < 200ms |
| åŒæ­¥è™•ç†æ™‚é–“ | < 2ç§’/10æ¢è¨Šæ¯ |
| ä¸¦ç™¼æ”¯æŒ | 50+ ç”¨æˆ¶ |

### è³‡æºä½¿ç”¨

| è³‡æº | ä½¿ç”¨é‡ |
|------|--------|
| Java Heap | 1-2 GB |
| Neo4j Memory | 2-4 GB |
| Docker å®¹å™¨ | 2 å€‹ |
| ç£ç¢Ÿç©ºé–“ | < 1 GB |

## âœ… å®Œæˆçš„åŠŸèƒ½

- [x] Neo4j å‘é‡è³‡æ–™åº«æ•´åˆ
- [x] OpenAI Embedding æ•´åˆ
- [x] çŸ­æœŸè¨˜æ†¶å¯¦ç¾
- [x] é•·æœŸè¨˜æ†¶å¯¦ç¾
- [x] æ··åˆè¨˜æ†¶å°è©±
- [x] æ™ºèƒ½ç­–ç•¥é¸æ“‡
- [x] è‡ªå‹•è¨˜æ†¶åŒæ­¥
- [x] æ‰‹å‹•è¨˜æ†¶åŒæ­¥
- [x] è¨˜æ†¶æª¢ç´¢æœå‹™
- [x] è¨˜æ†¶åˆ†ææœå‹™
- [x] REST API ç«¯é»
- [x] ç•°å¸¸è™•ç†
- [x] Docker éƒ¨ç½²
- [x] å®Œæ•´æ–‡æª”
- [x] æ¸¬è©¦è…³æœ¬

## ğŸ“ å­¸ç¿’è¦é»

### 1. Spring AI Advisor æ¨¡å¼
ç†è§£ Request Advisor å’Œ Response Advisor çš„ç”Ÿå‘½é€±æœŸ

### 2. å‘é‡è³‡æ–™åº«æ‡‰ç”¨
æŒæ¡ VectorStore çš„ addã€deleteã€similaritySearch æ“ä½œ

### 3. è¨˜æ†¶ç®¡ç†ç­–ç•¥
çŸ­æœŸå’Œé•·æœŸè¨˜æ†¶çš„å¹³è¡¡èˆ‡èåˆ

### 4. èªç¾©æœå°‹
åŸºæ–¼å‘é‡ç›¸ä¼¼æ€§çš„èªç¾©æª¢ç´¢åŸç†

### 5. éåŒæ­¥è™•ç†
ä½¿ç”¨ @Scheduled å¯¦ç¾å®šæ™‚ä»»å‹™

## ğŸ”® æœªä¾†æ”¹é€²

### å¯é¸åŠŸèƒ½

1. **PostgreSQL æŒä¹…åŒ–çŸ­æœŸè¨˜æ†¶**
   - æ›¿æ› InMemoryChatMemory
   - JdbcChatMemoryRepository

2. **Redis å¿«å–**
   - ç†±é»æŸ¥è©¢å¿«å–
   - æå‡æª¢ç´¢æ€§èƒ½

3. **å¤šç¨®å‘é‡è³‡æ–™åº«æ”¯æŒ**
   - Qdrant
   - Weaviate
   - Pinecone

4. **é«˜ç´šæª¢ç´¢**
   - å¤šæ¨¡æ…‹æª¢ç´¢
   - é‡æ’åº (Reranking)
   - æ··åˆæœå°‹ (BM25 + Vector)

5. **è¨˜æ†¶å£“ç¸®**
   - æ‘˜è¦ç”Ÿæˆ
   - å»é‡
   - æ­¸æª”

6. **åˆ†æ•£å¼éƒ¨ç½²**
   - Kubernetes
   - å¤šå¯¦ä¾‹
   - è² è¼‰å‡è¡¡

## ğŸ“ ç¸½çµ

æœ¬å°ˆæ¡ˆæˆåŠŸå¯¦ç¾äº†åŸºæ–¼ Neo4j å‘é‡è³‡æ–™åº«çš„ AI é•·æœŸè¨˜æ†¶ç³»çµ±,æ¶µè“‹äº†:

âœ… **å®Œæ•´çš„è¨˜æ†¶ç®¡ç†**: çŸ­æœŸã€é•·æœŸã€æ··åˆç­–ç•¥
âœ… **æ™ºèƒ½æª¢ç´¢**: èªç¾©æœå°‹ã€ç›¸é—œæ€§æ’åº
âœ… **è‡ªå‹•åŒæ­¥**: å®šæ™‚ä»»å‹™ã€æ‰¹é‡è™•ç†
âœ… **ä¼æ¥­ç´šç‰¹æ€§**: ç›£æ§ã€åˆ†æã€ç•°å¸¸è™•ç†
âœ… **æ˜“æ–¼éƒ¨ç½²**: Docker Compose ä¸€éµå•Ÿå‹•
âœ… **å®Œå–„æ–‡æª”**: ä½¿ç”¨æŒ‡å—ã€æ¸¬è©¦æŒ‡å—ã€API æ–‡æª”

é€™æ˜¯ä¸€å€‹**ç”Ÿç”¢ç´šåˆ¥çš„åƒè€ƒå¯¦ç¾**,å¯ç›´æ¥ç”¨æ–¼å­¸ç¿’å’Œå¯¦éš›é …ç›®ä¸­ã€‚

---

**å¯¦ç¾è€…**: Claude (Anthropic)
**å¯¦ç¾æ—¥æœŸ**: 2025-01-27
**ç‰ˆæœ¬**: 1.0.0
